<!DOCTYPE html>
<html lang="fa">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Simple Chat</title>
    <style>
        :root {
            --header-bg: #6B083F;
            --header-label-bg: #510E30;
        }

        body {
            font-family: sans-serif;
            background: #121212;
            display: flex;
            justify-content: center;
            align-items: center;
            height: 100vh;
            height: 100svh;
        }

        .chat-container {
            width: 350px;
            background: #E4C7F1;
            border-radius: 8px;
            box-shadow: 0 2px 10px rgba(0, 0, 0, 0.1);
            display: flex;
            flex-direction: column;
            min-height: 300px;
            position: relative;

            p {
                margin: 0;
            }

            .message {
                display: flex;
                flex-direction: column;

                background-color: #103459;
                color: #efefef;
               &:not(.merge-up){ margin-top: 25px;}

                &.compact-mode {
                    flex-direction: row;
                    width: 300px;

                    p {
                        flex-grow: 1;
                    }
                }

                small {
                    align-self: flex-end;
                    font-size: smaller;
                    opacity: 0.7;
                }

                &::before {
                    background-color: #103559;
                    padding: 0 5px;
                    content: attr(data-sender);
                    position: absolute;
                    font-size: smaller;
                    border-radius: 5px;
                    top: 0;
                    left: 0;
                    margin-top: -17px;
                    margin-left: -10px;
                }
            }
        }


        .chat-messages {
            flex: 1;
            padding: 5px 0;
            overflow-y: auto;
        }

        .message {
            margin-bottom: 8px;
            padding: 8px 10px;
            border-radius: 6px;
            max-width: 80%;
            font-size: 14px;
            position: relative;

        }

        .message.user {
            background: #e0e7ff;
            align-self: flex-end;
        }

        .message.other {
            background: rgba(243, 244, 246, 0.532);
            align-self: flex-start;
        }

        .chat-input {
            display: flex;
            border-top: 1px solid #ddd;
        }

        .chat-input input {
            flex: 1;
            padding: 10px;
            border: none;
            outline: none;
            font-size: 14px;
            caret-color: red;
            background-color: #efefef;

        }

        .chat-input button {
            padding: 0 15px;
            background: #8D26B9;
            color: white;
            border: none;
            cursor: pointer;
        }

        .chat-input button:hover {
            background: #4338ca;
        }

        .user-setting {

            background: var(--header-bg);
            display: none;

            &.active {
                display: flex;
                flex-direction: column;
                position: absolute;
                width: 350px;

                padding: 10px;
            }
        }

        * {
            box-sizing: border-box;
        }

        .header-toolbar {
            padding: 10px;
            background: var(--header-bg);
            color: white;
            border-radius: 8px 8px 0 0;
            font-family: monospace;
            display: flex;
            justify-content: space-between;
            align-items: center;
            height: 40px;
        }


        .icon-button {
            display: flex;
            background-color: transparent;
            border: none;
            cursor: pointer;

            svg {
                width: 16px;
                height: 16px;

                path {
                    fill: #efefef;
                }
            }
        }

        .cupertino-input {
            width: 100%;
            padding: 12px;
            border-radius: 12px;
            /* Rounded corners */
            border: 1px solid #510869;
            /* Light gray border */
            background: #F5D8EE;
            font-size: 16px;
            color: #000;
            box-shadow: inset 0 1px 2px rgba(0, 0, 0, 0.1);
            outline: none;
            transition: border-color 0.3s, box-shadow 0.3s;
        }

        .cupertino-input:focus {
            border-color: #E1316A;
            background-color: white;
            /* Blue border on focus */
            box-shadow: 0 0 5px rgba(244, 163, 191, 0.2);
        }

        .cupertino-input::placeholder {
            color: #8e8e93;
            /* Light gray for placeholder */
            opacity: 1;
        }

        /* Cupertino Button Styling */
        .cupertino-button {
            padding: 12px 24px;
            /* Padding for the button */
            font-size: 16px;
            /* Font size */
            color: white;
            /* Text color */
            background-color: #007aff;
            /* Blue background (standard iOS blue) */
            border: none;
            /* No border */
            border-radius: 20px;
            /* Rounded corners */
            box-shadow: 0 4px 10px rgba(0, 0, 0, 0.1);
            /* Subtle shadow */
            cursor: pointer;
            /* Pointer cursor */
            outline: none;
            /* Remove outline */
            transition: background-color 0.2s, transform 0.1s ease-in-out;
            /* Transition for smooth effects */
        }

        /* Hover effect */
        .cupertino-button:hover {
            background-color: #0051cc;
            /* Darker blue on hover */
        }

        /* Active effect */
        .cupertino-button:active {
            transform: scale(0.98);
            /* Slight shrink when pressed */
            background-color: #0041a3;
            /* Even darker blue when clicked */
        }

        label {

            color: #efefef;
            display: flex;
            flex-direction: column;

            span {
                border-radius: 5px;
                padding: 0 5px;
                margin-bottom: -10px;
                background-color: var(--header-label-bg);
                align-self: flex-start;
                margin-inline-start: 10px;
                z-index: 10;
                font-size: smaller;
            }
        }

        .fake-link {
            user-select: none;
            cursor: pointer;
            border: 1px solid var(--header-label-bg);
        }

        .seperator {
            opacity: 0.7;
        }

        .bread-crumb {
            display: flex;
            align-items: center;

            :not(:first-child)::before {
                content: "/";
                opacity: 0.5;
            }
        }

        .merge-down {
            margin-bottom: 0;
            border-radius: 6px 6px 0 0;
            padding-bottom: 0;

            small {
                display: none !important;
            }
        }

        .merge-up {
            margin-top: 0;
            border-radius: 0 0 6px 6px;
            padding-top: 0;

            &::before {
                display: none !important;
            }
        }
    </style>
</head>

<body>

    <div class="chat-container">
        <div class="chat-header header-toolbar">
            <div>
                chat: <span id="sender-name">----</span>
            </div>
            <button class="icon-button" onclick="OpenSetting()">
                <svg xmlns="http://www.w3.org/2000/svg"
                    viewBox="4.954591751098633 4.001092910766602 38.09081840515137 39.9989070892334">
                    <path
                        d="M39.139,26.282C38.426,25.759,38,24.919,38,24.034s0.426-1.725,1.138-2.247l3.294-2.415c0.525-0.386,0.742-1.065,0.537-1.684c-0.848-2.548-2.189-4.872-3.987-6.909c-0.433-0.488-1.131-0.642-1.728-0.38l-3.709,1.631c-0.808,0.356-1.749,0.305-2.516-0.138c-0.766-0.442-1.28-1.23-1.377-2.109l-0.446-4.072c-0.071-0.648-0.553-1.176-1.191-1.307c-2.597-0.531-5.326-0.54-7.969-0.01c-0.642,0.129-1.125,0.657-1.196,1.308l-0.442,4.046c-0.097,0.88-0.611,1.668-1.379,2.11c-0.766,0.442-1.704,0.495-2.515,0.138l-3.729-1.64c-0.592-0.262-1.292-0.11-1.725,0.377c-1.804,2.029-3.151,4.35-4.008,6.896c-0.208,0.618,0.008,1.301,0.535,1.688l3.273,2.4C9.574,22.241,10,23.081,10,23.966s-0.426,1.725-1.138,2.247l-3.294,2.415c-0.525,0.386-0.742,1.065-0.537,1.684c0.848,2.548,2.189,4.872,3.987,6.909c0.433,0.489,1.133,0.644,1.728,0.38l3.709-1.631c0.808-0.356,1.748-0.305,2.516,0.138c0.766,0.442,1.28,1.23,1.377,2.109l0.446,4.072c0.071,0.648,0.553,1.176,1.191,1.307C21.299,43.864,22.649,44,24,44c1.318,0,2.648-0.133,3.953-0.395c0.642-0.129,1.125-0.657,1.196-1.308l0.443-4.046c0.097-0.88,0.611-1.668,1.379-2.11c0.766-0.441,1.705-0.493,2.515-0.138l3.729,1.64c0.594,0.263,1.292,0.111,1.725-0.377c1.804-2.029,3.151-4.35,4.008-6.896c0.208-0.618-0.008-1.301-0.535-1.688L39.139,26.282z M24,31c-3.866,0-7-3.134-7-7s3.134-7,7-7s7,3.134,7,7S27.866,31,24,31z">
                    </path>
                </svg>
            </button>
        </div>

        <div class="chat-messages" id="messages"></div>




        <div class="user-setting stack-panel" id="form-1a6b75a5">
            <section class="header-toolbar">
                <div class="bread-crumb">
                    <span class="fake-link" onclick="CloseSetting()">üè†</span>
                    <span>Settings</span>
                </div>
                <button class="icon-button" onclick="CloseSetting()">
                    <svg xmlns="http://www.w3.org/2000/svg"
                        viewBox="6.970975399017334 6.97014045715332 34.058985233306885 34.05888557434082">
                        <path
                            d="M38.982422 6.9707031 A 2.0002 2.0002 0 0 0 37.585938 7.5859375L24 21.171875L10.414062 7.5859375 A 2.0002 2.0002 0 0 0 8.9785156 6.9804688 A 2.0002 2.0002 0 0 0 7.5859375 10.414062L21.171875 24L7.5859375 37.585938 A 2.0002 2.0002 0 1 0 10.414062 40.414062L24 26.828125L37.585938 40.414062 A 2.0002 2.0002 0 1 0 40.414062 37.585938L26.828125 24L40.414062 10.414062 A 2.0002 2.0002 0 0 0 38.982422 6.9707031 z">
                        </path>
                    </svg>
                </button>
            </section>
            <section>

                <label>
                    <span>Username</span>
                    <input type="text" class="cupertino-input" id="input-4eca11e2" placeholder="UserName" />
                </label>


            </section>
        </div>

        <div class="chat-input">
            <input type="text" id="messageInput" placeholder="Write Your Message" />
            <button onclick="PostMessage()">Send</button>
        </div>
    </div>

    <script>
        const messagesEl = document.getElementById('messages');
        const inputEl = document.getElementById('messageInput');
        const txtSenderName = document.getElementById('sender-name');

        function PostMessage() {
            const message = inputEl.value.trim();
            if (!message) return;

            addMessage(message, 'user');
            inputEl.value = '';

            const formData = new FormData();
            formData.append('message', message);
            formData.append('sender', txtSenderName.innerText);

            fetch("https://chat.mise.ir/", {
                method: 'POST',
                body: formData
            })
                .then(response => response.json())
                .then(result => {
                    if (result.status === 'success') {
                        loadMessages(); // ÿ®ÿßÿ±⁄Øÿ∞ÿßÿ±€å Ÿæ€åÿßŸÖ‚ÄåŸáÿß ÿ®ÿπÿØ ÿßÿ≤ ÿßÿ±ÿ≥ÿßŸÑ
                        document.getElementById('message').value = ''; // Ÿæÿß⁄© ⁄©ÿ±ÿØŸÜ Ÿàÿ±ŸàÿØ€å Ÿæ€åÿßŸÖ
                    } else {
                        alert(result.message);
                    }
                })
                .catch(error => console.error('Error:', error));

            // ÿ¥ÿ®€åŸá‚Äåÿ≥ÿßÿ≤€å Ÿæÿßÿ≥ÿÆ ÿ∑ÿ±ŸÅ ŸÖŸÇÿßÿ®ŸÑ
            setTimeout(() => {
                addMessage('Sample Response ü§ñ', 'other');
            }, 800);
        }

        function addMessage(text, type) {
            const msg = document.createElement('div');
            msg.className = `message ${type}`;
            msg.innerHTML = text;
            messagesEl.appendChild(msg);
            messagesEl.scrollTop = messagesEl.scrollHeight;


            MessageOptimization(messagesEl);


        }



        // ÿßÿ±ÿ≥ÿßŸÑ ÿ®ÿß Enter
        inputEl.addEventListener('keydown', e => {
            if (e.key === 'Enter') PostMessage();
        });




        fetch("https://chat.mise.ir/").then(g => g.text()).then(g => {
            if (g.startsWith("{")) {

                return;
            }
            addMessage(g, 'other');
        })


        //>> Username
        function generateRandomUsername() {
            // ÿ™ŸàŸÑ€åÿØ €å⁄© ÿπÿØÿØ ÿ™ÿµÿßÿØŸÅ€å ÿ®€åŸÜ 100 Ÿà 999
            const randomNumber = Math.floor(Math.random() * 900) + 100; // ÿß€åŸÜ ŸÖŸÇÿØÿßÿ± ŸáŸÖ€åÿ¥Ÿá 3 ÿ±ŸÇŸÖ€å ÿÆŸàÿßŸáÿØ ÿ®ŸàÿØ
            return `user-${randomNumber}`;
        }


        if (sessionStorage.getItem("username"))
            txtSenderName.innerHTML = sessionStorage.getItem("username");
        else {
            txtSenderName.innerHTML = generateRandomUsername();
            sessionStorage.setItem("username", txtSenderName.innerHTML)
        }

        function OpenSetting() {
            var form = document.getElementById("form-1a6b75a5");
            form.classList.add("active");

            var input = document.getElementById("input-4eca11e2");
            input.value = txtSenderName.innerHTML;
            input.focus();
            input.select();

            input.oninput = () => {
                var txt = input.value.trim();
                txt = txt.replace(/[^a-zA-Z0-9\s]/g, '');
                txtSenderName.innerHTML = txt;
                if (txt.length < 3) txtSenderName.innerHTML = "user-" + txt;
                if (txt.length == 0) txtSenderName.innerHTML = sessionStorage.getItem("username");
                console.log(txtSenderName.innerHTML);
            }



        }

        function CloseSetting() {
            var form = document.getElementById("form-1a6b75a5");
            form.classList.remove("active");

            sessionStorage.setItem("username", txtSenderName.innerHTML);
        }


        function formatDate(dateString) {
            const messageDate = new Date(dateString);
            const today = new Date();

            const messageDateString = messageDate.toISOString().split('T')[0];
            const todayDateString = today.toISOString().split('T')[0];

            const hours = messageDate.getHours().toString().padStart(2, '0');
            const minutes = messageDate.getMinutes().toString().padStart(2, '0');

            if (messageDateString === todayDateString) {
                // If message is from today, show only hours and minutes
                return `${hours}:${minutes}`;
            } else {
                // If message is from another day, show full date (MM-DD) and time
                const month = (messageDate.getMonth() + 1).toString().padStart(2, '0');
                const day = messageDate.getDate().toString().padStart(2, '0');
                return `${month}-${day} ${hours}:${minutes}`;
            }
        }
        function MessageOptimization(el) {
            const messagesList = el.querySelectorAll('.message');

            for (let i = 0; i < messagesList.length - 1; i++) {
                const current = messagesList[i];
                const next = messagesList[i + 1];

                const sender1 = current.dataset.sender;
                const sender2 = next.dataset.sender;


                const time1 = new Date(current.querySelector('small').textContent);
                const time2 = new Date(next.querySelector('small').textContent);




                if (sender1 !== sender2) continue;
                const diffMinutes = (time2 - time1) / (1000 * 60);

                if (diffMinutes <= 10) {
                    current.classList.add('merge-down');
                    next.classList.add('merge-up');
                }
            }


            el.querySelectorAll("small").forEach(small => {
                const originalDate = small.textContent;
                console.log(originalDate)
                small.textContent = formatDate(originalDate);
            });



            const range = document.createRange();

            messagesList.forEach(message => {

                var pTag = message.querySelector("p");
                range.selectNodeContents(pTag);
                const contentWidth = range.getBoundingClientRect().width;

                if (contentWidth < 200) {
                    message.classList.add('compact-mode');
                }
            });


        };
    </script>

</body>

</html>